<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Change CovidState</title>

    <!-- Bootstrap core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/css/scrolling-nav.css" rel="stylesheet">

</head>
<body id="page-top">

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
    <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">Covid-Alert</a>
</nav>
<section>

    <div class="container">
        <div class="row justify-content-md-center">
            <h2>
                Current State: <span class="badge badge-pill badge-light" th:text="${personState.getCovidState().stateLabel}"></span>
            </h2>
        </div>
        <div class="row">
            <div>
                <form id="register_form">
                    <h3><U>Please select your new state :</U></h3>
                    <div th:if="${personState.getCovidState().stateId}==0 or ${personState.getCovidState().stateId}==2" class="form-check">
                        <input class="form-check-input" type="radio" id="covidStateChoice2" name="stateId" value="1">
                        <label class="form-check-label" for="covidStateChoice2">Positive</label>
                    </div>
                    <div th:if="${personState.getCovidState().stateId}==0 or ${personState.getCovidState().stateId}==1">
                        <input type="radio" id="covidStateChoice1" name="stateId" value="2">
                        <label for="covidStateChoice1">Negative</label>
                    </div>
                    <div>
                        <button id="submit-btn" class="btn btn-primary" type="submit">Update my state</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>



<!-- Bootstrap core JavaScript -->
<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Plugin JavaScript -->
<script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom JavaScript for this theme -->
<script src="/js/scrolling-nav.js"></script>

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="http://localhost:8080/auth/js/keycloak.js" type="text/javascript"></script>
<script type="text/javascript" th:inline="javascript">

    const keycloak = Keycloak({
        "realm": "covid-alert",
        "auth-server-url": "http://localhost:8080/auth",
        "ssl-required": "external",
        "resource": "covid-alert/user-app",
        "public-client": true,
        "confidential-port": 0,
        "url": 'http://localhost:8080/auth',
        "clientId": 'user-app',
        "enable-cors": true
    });

    const loadData = () => {
        console.log(keycloak.subject);
        if (keycloak.idToken) {
        } else {
            keycloak.loadUserProfile(function() {
            }, function() {
                //console.log('Failed to retrieve user details. Please enable claims or account role');
            });
        }
    };
    const reloadData = () => {
        keycloak.updateToken()
            .success(loadData)
            .error(() => {
                //console.log('Failed to load data.  User is logged out.');
            });
    }


    $( document ).ready(function() {
        keycloak.init({onLoad: 'login-required', "checkLoginIframe": false}).success(reloadData);
    });

    const serialize_form = form => JSON.stringify(
        Array.from(new FormData(form).entries())
            .reduce((m, [ key, value ]) => Object.assign(m, { [key]: value }), {})
    );

    $('#register_form').on('submit', function(event) {
        event.preventDefault();
        const json = serialize_form(this);
        $.ajax({
            type: 'POST',
            url: '/personState/update',
            headers: {
                "Authorization": "Bearer " + keycloak.token
            },
            dataType: 'json',
            data: json,
            contentType: 'application/json',
            success: function(data) {
                console.log(data)
                alert("Your status have been updated successfuly")
                $("#submit-btn").attr("disabled", true);
            }
        });
    });

</script>

</html>